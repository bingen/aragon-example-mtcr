# Aragon Minimal TCR example

This is an example of a simple app created using aragon cli tool. Based on [this guide](https://gist.github.com/onbjerg/5c2658bd2fa206167b6e66fcd8ffa617)

## Prerequisites

- [**truffle**](https://github.com/trufflesuite/truffle): Used to build and test the contracts
- [**@aragon/cli**](https://github.com/aragon/aragon-dev-cli): Used to publish the application
- [**webpack-cli**](https://webpack.js.org/api/cli/): Or the bundler you like, to build the frontend.

This repo has git tags (`v1`, `v2`, `v3`) that appear in this guide in parenthesis to indicate the different steps of the build process. You can checkout each of them to see the result.

## Init app (v1)

```sh
aragon-dev-cli init mtcr.aragonpm.eth bare
cd mtcr
```

## Create smart contract

Edit `contracts/App.sol` to add your own logic, install any other needed dependency, e.g.:

```
npm i @aragon/apps-voting
```

and compile it:

```
truffle compile
```

## Add some tests

Kind of optional, but absolutely recommended ;-)
Edit `test/app.js` and make sure everything works as expected, with:

```
npm run test
```

## Build Front end

Install Aragon.js:

```
cd app
npm init
npm i @aragon/client
```

Create a background worker, `src/worker.js`, to :

```
const Aragon = require('@aragon/client').default

// Initialise the app
const app = new Aragon()

// Listen for events and reduce them to a state
const state$ = app.store((state, event) => {
  // Initial state
  if (state === null) state = 0

  // Build state
  switch (event.event) {
  case 'NewEntry':
    state++
    break
  case 'DelEntry':
    state--
    break
  default:
    console.log('Unkwnown event')
    break
  }

  return state
})
```

And your view, with a simple `index.html`:

```
<!doctype>
<html>
  <body>
    <div id="view">...</div>
    <script src="public/app.js"></script>
  </body>
</html>
```

and a Javascript file `src/app.js` that observes the events generated by our worker:

```
import Aragon, { providers } from '@aragon/client'

const app = new Aragon(new providers.WindowMessage(window.parent))
const view = document.getElementById('view')

// ugly hack: aragon.js doesn't have handshakes yet
// the wrapper is sending a message to the app before the app's ready to handle it
// the iframe needs some time to set itself up,
// so we put a timeout to wait for 5s before subscribing
setTimeout(subscribe, 5000)

function subscribe() {
  app.state().subscribe(
    (state) => {
      console.log('app.js state ', state)
      view.innerHTML = `The counter is ${state}`
    },
    (err) => {
      view.innerHTML = 'An error occured, check the console'
      console.log(err)
    }
  )
}
```

As we are using Node.js modules, we need a builder, e.g., webpack, so add the following `webpack.config.js` file too:

```
module.exports = {
  entry: {
    app: './src/app.js',
    worker: './src/worker.js'
  },
  output: {
    filename: '[name].js',
    path: __dirname + '/public'
  }
}
```

Add the following line to `package.json`:

```
    "build": "webpack"
```

And finally build the frontend:

```
npm run build
cd ..
```

## Tweak config files

Edit `arapp.json`, change your app name and add your roles.

Edit `manifest.json`, change description and add:
```
"start_url": "/public/index.html",
"script": "/public/worker.js"
```

## Start a local IPFS node

Out of scope, you can start a docker instance like [here](https://github.com/aragon/aragon-apps/blob/master/templates/beta/docker-compose.yml)

## Do the magic

```
aragon run
```

You can open a `truffle console` and interact with your just deployed contract (just replace the app address by yours):

```
> App.at("0x7ceB61328BD062D3534C6529823d0990653A9aC6").add("test 5").then(function(r){console.log(r.logs[0].args)})
```

## Start your Aragon dApp locally

Get the repo and install deps

```
git clone https://github.com/aragon/aragon.git
yarn install
```

Then edit `src/environment.js` and replace the infura node section by:

```
  rpc: {
    host: 'localhost',
    port: '5001',
    protocol: 'http',
  },
```

And start it, using ENS address by the one generated by `aragon run`:

```
REACT_APP_DEFAULT_ETH_NODE=ws://localhost:8545 REACT_APP_IPFS_GATEWAY=http://localhost:8080/ipfs REACT_APP_ETH_NETWORK_TYPE=local REACT_APP_ENS_REGISTRY_ADDRESS=0xB9462EF3441346dBc6E49236Edbb0dF207db09B7 yarn start
```

Now you can go to:

```
https://localhost:3000/#/<your-DAO-address-generated-before>
```

## Upgrading (v2)

Make your changes, update version in `arapp.json` and run (replace ENS address by your previous one):

```
aragon publish --apm.ipfs.rpc.host localhost --apm.ens-registry 0xB9462EF3441346dBc6E49236Edbb0dF207db09B7 --key <the-first-private-key-that-aragon-run-gave-you>
```

If you are changing your contracts, then you have to compile, deploy, make sure that you update your version in `arapp.json` to a major one and pass the new deployed contract to the publish script:

```
truffle compile
truffle exec scripts/deploy.js --netowrk rpc
aragon \
    --apm.ipfs.rpc.host localhost \
    --apm.ens-registry 0xB9462EF3441346dBc6E49236Edbb0dF207db09B7 \
    --key <the-first-private-key-that-aragon-run-gave-you> \
    publish <the-contract-address-just-generated-in-last-step>
```

Besides you have to manually upgrade it in your DAO too, e.g., open a `truffle console` and run:

```
> Kernel.at("0x9A3B7C7EBcE69ebfab795cd28Dbc7172B93f88F3").setApp("0xf1f3eb40f5bc1ad1344716ced8b8a0431d840b5783aea1fd01786bc26f35ac0f", "0x803f5de74ffb6f2a3b102bad434681a663525dea27c69ba347f57b370f2eb555", "0xB529f14AA8096f943177c09Ca294Ad66d2E08b1f")
```

Where first param (`0xf1f3eb40f5bc1ad1344716ced8b8a0431d840b5783aea1fd01786bc26f35ac0f`) is `APP_BASES_NAMESPACE` and second one (`0x803f5de74ffb6f2a3b102bad434681a663525dea27c69ba347f57b370f2eb555`) is your app name (you can get it from `aragon run` output). Last parameter is your contract last version address.
Replace also the address of your DAO to instantiate kernel.

If you have added new permissions to the app, you will have to create them in your DAO, e.g., with `truffle console`:

```
> ACL.at("0x1e28bcd5349a5b0ea7a4cdd70441a734cce360bb").createPermission("0x627306090abab3a6e1400e9345bc60c78a8bef57", "0x7ceB61328BD062D3534C6529823d0990653A9aC6", "0x807a48ea404c453cc6a470f28aa312d410deebe15fd841217c9ccc9924c0a7e1", "0x627306090abab3a6e1400e9345bc60c78a8bef57", { from: "0x627306090abab3a6e1400e9345bc60c78a8bef57" } )
```
First parameter is the granted adress (first account in this case), second one is the proxy address of your App that you can get from `aragon run` output, third one is the `keccak256` hash of your new role ("DEL_ROLE" in this case) and last one is the permission manager (first account again).

You can get your ACL address with:

```
> Kernel.at("0x9A3B7C7EBcE69ebfab795cd28Dbc7172B93f88F3").acl()
```

To get the the `keccak256` hash of your role you can use this simple Javascript snippet:

```
const sha3 = require('js-sha3')

console.log('DEL ROLE', sha3.keccak256('DEL_ROLE'))
```

or scroll down to "SHA3" section [here](https://www.mycrypto.com/helpers.html), or [here](http://emn178.github.io/online-tools/keccak_256.html).

You can check your versions with:

```
aragon --apm.ipfs.rpc.host localhost --apm.ens-registry 0xB9462EF3441346dBc6E49236Edbb0dF207db09B7 versions
```

## Add Voting into the Mix (v3)

Let's say you want to integrate with another existing Aragon App, Voting in this case. First modify your contract logic. If you didn't do it, make sure you have your dependencies too.

Then you have to manually add the Voting app to your DAO and adjust permissions. Have a look at the [migration script]() created for it and run it with:

```
ENS=0xB9462EF3441346dBc6E49236Edbb0dF207db09B7 DAO=0x9A3B7C7EBcE69ebfab795cd28Dbc7172B93f88F3 APP=0x7ceB61328BD062D3534C6529823d0990653A9aC6 truffle migrate --network rpc --reset
```

(adjusting of course to your own addresses)
